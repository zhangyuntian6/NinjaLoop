{"version":3,"sources":["file:///D:/NinjaLoop/assets/Script/UI/DistributePropPanel.ts"],"names":["_decorator","Node","Prefab","Label","instantiate","resources","Message","lifeMgr","eventMsg","DistributePropItem","UIPanel","ccclass","property","DistributePropPanel","type","totalPoints","distributePropItemsMap","Map","distributePropKeys","propNameMap","start","init","selectedTalentList","load","err","jsonAsset","console","error","config","json","DistributePropKeys","PropConfig","InitialPoints","PropNameMap","propGroup","removeAllChildren","clear","forEach","key","set","createPropItem","getTalentAllocationAddition","map","id","updateLeftPoints","name","itemNode","distributePropItemPrfb","setParent","item","getComponent","setTitle","point","onAddButtonClick","onItemAddButtonClick","bind","onReduceButtonClick","onItemReduceButtonClick","getLeftPoints","usedPoints","Array","from","values","reduce","pre","cur","totalPointsLbl","string","toString","onCheckButtonClicked","propData","SPR","InitialSPR","get","emit","DistributePropEnd","onRandomDistributeButtonClicked","t","arr","sub","Math","round","random","min","select","floor","keys","index","onShow"],"mappings":"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","sourcesContent":["\nimport { _decorator, Component, Node, Prefab, Label, instantiate, resources } from 'cc';\nimport { Message } from '../Defines';\nimport { lifeMgr } from '../Life';\nimport { ITalentInfo } from '../Talent';\nimport { eventMsg } from '../Utils/EventMessage';\nimport { DistributePropItem } from './DistributePropItem';\nimport { UIPanel } from './UIPanel';\nconst { ccclass, property } = _decorator;\n\n@ccclass('DistributePropPanel')\nexport class DistributePropPanel extends UIPanel {\n    @property({type: Node})\n    public propGroup: Node;\n    @property({type: Prefab})\n    public distributePropItemPrfb: Prefab;\n    @property({type: Label})\n    public totalPointsLbl: Label;\n\n    private totalPoints: number = 20;\n    private distributePropItemsMap: Map<string, DistributePropItem> = new Map<string, DistributePropItem>();\n    private distributePropKeys: string[] = [];\n    private propNameMap: {[key: string]: string} = {};\n\n    start() {\n        // 移除start中的配置加载，因为init方法会处理\n    }\n\n    public init(selectedTalentList: ITalentInfo[]) {\n        // 确保配置加载完成后再初始化界面\n        resources.load('defines', (err, jsonAsset: any) => {\n            if (err) {\n                console.error('Failed to load defines.json:', err);\n                return;\n            }\n            \n            const config = jsonAsset.json;\n            this.distributePropKeys = config.DistributePropKeys;\n            this.totalPoints = config.PropConfig.InitialPoints;\n            this.propNameMap = config.PropNameMap;\n            \n            // 初始化界面\n            this.propGroup.removeAllChildren();\n            this.distributePropItemsMap.clear();\n            this.distributePropKeys.forEach((key) => {\n                this.distributePropItemsMap.set(key, this.createPropItem(key, this.propNameMap[key]));\n            });\n\n            // calculate total points\n            this.totalPoints += lifeMgr.getTalentAllocationAddition(selectedTalentList.map(({id}) => id));\n\n            this.updateLeftPoints();\n        });\n    }\n\n    public createPropItem(key:string, name:string) {\n        const itemNode = instantiate(this.distributePropItemPrfb);\n        itemNode.setParent(this.propGroup);\n        const item = itemNode.getComponent(DistributePropItem);\n        item.setTitle(name);\n        item.key = key;\n        item.point = 0;\n        item.onAddButtonClick = this.onItemAddButtonClick.bind(this);\n        item.onReduceButtonClick = this.onItemReduceButtonClick.bind(this);\n        return item;\n    }\n\n    public getLeftPoints() {\n        const usedPoints = Array.from(this.distributePropItemsMap.values()).reduce((pre, cur)=> {\n            return pre + cur.point;\n        }, 0);\n\n        return this.totalPoints - usedPoints;\n    }\n\n    public onItemAddButtonClick(item: DistributePropItem) {\n        if (this.getLeftPoints() > 0) {\n            item.point += 1;\n            this.updateLeftPoints()\n        }\n    }\n\n    public onItemReduceButtonClick(item: DistributePropItem) {\n        if(item.point > 0) {\n            item.point -= 1;\n            this.updateLeftPoints();\n        }\n    }\n\n    public updateLeftPoints() {\n        this.totalPointsLbl.string = this.getLeftPoints().toString();\n    }\n\n    public onCheckButtonClicked() {\n        resources.load('defines', (err, jsonAsset: any) => {\n            if (err) {\n                console.error('Failed to load defines.json:', err);\n                return;\n            }\n            const config = jsonAsset.json;\n            const propData = {\n                SPR: config.PropConfig.InitialSPR\n            }\n            this.distributePropKeys.forEach((key) => {\n                propData[key] = this.distributePropItemsMap.get(key).point;\n            });\n            eventMsg.emit(Message.DistributePropEnd, propData);\n        });\n    }\n\n    public onRandomDistributeButtonClicked() {\n        let t = this.totalPoints;\n        const arr = [10, 10, 10, 10];\n        while(t>0) {\n            const sub = Math.round(Math.random() * (Math.min(t, 10) - 1)) + 1;\n            while(true) {\n                const select = Math.floor(Math.random() * 4) % 4;\n                if(arr[select] - sub <0) continue;\n                arr[select] -= sub;\n                t -= sub;\n                break;\n            }\n        }\n\n        Array.from(this.distributePropItemsMap.keys()).forEach((key, index) => {\n            const item = this.distributePropItemsMap.get(key);\n            item.point = 10 - arr[index];\n        })\n\n        this.updateLeftPoints();\n    }\n\n    public onShow(selectedTalentList: ITalentInfo[]) {\n        this.init(selectedTalentList);\n    }\n\n    // update (deltaTime: number) {\n    //     // [4]\n    // }\n}\n"]}