{"version":3,"sources":["file:///D:/NinjaLoop/assets/Script/GameManager.ts"],"names":["_decorator","Component","Node","sys","Message","lifeMgr","AchievementHint","AchievementPanel","DistributePropPanel","LifeTrackPanel","SelectTalentPanel","StartMenuPanel","ConfigManager","eventMsg","ccclass","property","GameManager","type","_selectedTalentList","start","init","happyLife","specialthanks","Promise","all","initial","readJson","on","StartMenu","startMenuPanel","show","selectTalentPanel","hide","distributePropPanel","lifeTrackPanel","loadButtonNode","active","saveButtonNode","homeButtonNode","githubButtonNode","achievementButtonNode","StartGame","openSelectTalentPanel","TalentSelectEnd","selectedTalentList","DistributePropEnd","propData","Replay","times","Achievement","name","achievementHint","emit","talentList","talentRandom","save","platform","Platform","MOBILE_BROWSER","DESKTOP_BROWSER","data","Object","keys","localStorage","filter","v","substr","forEach","key","blob","Blob","JSON","stringify","slice","webkitSlice","mozSlice","call","size","a","document","createElementNS","href","URL","createObjectURL","download","Date","toISOString","replace","body","appendChild","click","removeChild","revokeObjectURL","load","file","createElement","accept","style","append","addEventListener","e","target","files","reader","FileReader","onload","parse","result","readAsText","onHomeButtonClicked","onGithubButtonClicked","openURL","onOpenAchievementButtonClicked","achievementPanel"],"mappings":"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","sourcesContent":["\nimport { _decorator, Component, Node, sys } from 'cc';\nimport { Message } from './Defines';\nimport { lifeMgr } from './Life';\nimport { ITalentInfo } from './Talent';\nimport { AchievementHint } from './UI/AchievementHint';\nimport { AchievementPanel } from './UI/AchievementPanel';\nimport { DistributePropPanel } from './UI/DistributePropPanel';\nimport { LifeTrackPanel } from './UI/LifeTrackPanel';\nimport { SelectTalentPanel } from './UI/SelectTalentPanel';\nimport { StartMenuPanel } from './UI/StartMenuPanel';\nimport ConfigManager from './Utils/ConfigManager';\nimport { eventMsg } from './Utils/EventMessage';\nconst { ccclass, property } = _decorator;\n\n@ccclass('GameManager')\nexport class GameManager extends Component {\n\n    @property({type: AchievementHint})\n    public achievementHint: AchievementHint;\n    @property({type: Node})\n    public saveButtonNode: Node;\n    @property({type: Node})\n    public loadButtonNode: Node;\n    @property({type: Node})\n    public homeButtonNode: Node;\n    @property({type: Node})\n    public githubButtonNode: Node;\n    @property({type: Node})\n    public achievementButtonNode: Node;\n\n    @property({type: StartMenuPanel})\n    public startMenuPanel: StartMenuPanel;\n\n    @property({type: AchievementPanel})\n    public achievementPanel: AchievementPanel;\n\n    @property({type: SelectTalentPanel})\n    public selectTalentPanel: SelectTalentPanel;\n\n    @property({type: DistributePropPanel})\n    public distributePropPanel: DistributePropPanel;\n\n    @property({type: LifeTrackPanel})\n    public lifeTrackPanel: LifeTrackPanel;\n\n    private _selectedTalentList: ITalentInfo[];\n\n    start () {\n        this.init();\n    }\n\n    async init() {\n        const [,happyLife, specialthanks] = await Promise.all([\n            lifeMgr.initial(),\n            ConfigManager.readJson('happy_life'),\n            ConfigManager.readJson('specialthanks')\n        ]);\n\n        eventMsg.on(Message.StartMenu, ()=> {\n            this.startMenuPanel.show(happyLife);\n            this.selectTalentPanel.hide();\n            this.distributePropPanel.hide();\n            this.lifeTrackPanel.hide();\n\n            this.loadButtonNode.active = true;\n            this.saveButtonNode.active = true;\n            this.homeButtonNode.active = false;\n            this.githubButtonNode.active = true;\n            this.achievementButtonNode.active = true;\n        });\n        \n        eventMsg.on(Message.StartGame, ()=> {\n            this.startMenuPanel.hide();\n            this.loadButtonNode.active = false;\n            this.saveButtonNode.active = false;\n            this.homeButtonNode.active = true;\n            this.githubButtonNode.active = false;\n            this.achievementButtonNode.active = false;\n            this.openSelectTalentPanel();\n        });\n\n        eventMsg.on(Message.TalentSelectEnd, (selectedTalentList)=> {\n            this._selectedTalentList = selectedTalentList;\n            this.selectTalentPanel.hide();\n            this.distributePropPanel.show(selectedTalentList);\n        })\n\n        eventMsg.on(Message.DistributePropEnd, (propData) => {\n            this.distributePropPanel.hide();\n            this.lifeTrackPanel.show(this._selectedTalentList, propData);\n        });\n\n        eventMsg.on(Message.Replay, ()=> {\n            this.lifeTrackPanel.hide();\n            lifeMgr.times++;\n            this.openSelectTalentPanel();\n        });\n\n        // achievement\n        eventMsg.on(Message.Achievement, ({name})=> {\n            this.achievementHint.show(name);\n        });\n\n\n        // start\n        eventMsg.emit(Message.StartMenu);\n    }\n\n    openSelectTalentPanel() {\n        const talentList = lifeMgr.talentRandom();\n        this.selectTalentPanel.show(talentList); \n    }\n\n    // update (deltaTime: number) {\n    //     // [4]\n    // }\n\n    public save() {\n        if (sys.platform === sys.Platform.MOBILE_BROWSER ||\n            sys.platform === sys.Platform.DESKTOP_BROWSER) {\n                const data = {};\n                Object\n                    .keys(localStorage)\n                    .filter(v=>v.substr(0,4)!='goog')\n                    .forEach(key=>data[key] = localStorage[key]);\n\n                let blob = new Blob([JSON.stringify(data)], { type: 'application/json' });\n                // @ts-ignore\n                const slice = blob.slice || blob.webkitSlice || blob.mozSlice;\n                blob = slice.call(blob, 0, blob.size, 'application/octet-stream');\n                const a = document.createElementNS('http://www.w3.org/1999/xhtml', 'a') as HTMLAnchorElement;\n\n                a.href = URL.createObjectURL(blob);\n                a.download = `Remake_save_${new Date().toISOString().replace(':','.')}.json`;\n\n                document.body.appendChild(a);\n                a.click();\n                document.body.removeChild(a);\n                URL.revokeObjectURL(a.href);\n        }\n    }\n\n    public load() {\n        if (sys.platform === sys.Platform.MOBILE_BROWSER ||\n            sys.platform === sys.Platform.DESKTOP_BROWSER) {\n                const file = document.createElement('input');\n                file.type = 'file';\n                file.name = 'file';\n                file.accept = \"application/json\";\n                // @ts-ignore\n                file.style = \"display: none;\";\n                file.append('body');\n                file.click();\n                file.addEventListener('change', (e)=>{\n                    // @ts-ignore\n                    const file = e.target.files[0];\n                    if(!file) return;\n                    const reader = new FileReader();\n                    reader.onload = () => {\n                        const data = JSON.parse(reader.result as string);\n                        for(const key in data) {\n                            localStorage[key] = data[key];\n                        }\n                        this.achievementHint.show('加载存档成功');\n                    }\n                    reader.readAsText(file);\n                });\n        }\n    }\n\n    public onHomeButtonClicked() {\n        eventMsg.emit(Message.StartMenu);\n    }\n\n    public onGithubButtonClicked() {\n        sys.openURL(\"https://github.com/gameall3d/LifeRestart_Cocos\");\n    }\n\n    public onOpenAchievementButtonClicked() {\n        this.achievementPanel.show();\n    }\n}"]}